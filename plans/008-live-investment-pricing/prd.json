[
  {
    "id": "1.1",
    "category": "migration",
    "passes": true,
    "description": "Create migration 000015: drop current_price and last_updated columns from investments table",
    "steps": [
      "Create apps/api/migrations/000015_drop_investment_current_price.up.sql",
      "ALTER TABLE investments DROP COLUMN IF EXISTS current_price; ALTER TABLE investments DROP COLUMN IF EXISTS last_updated;",
      "Create apps/api/migrations/000015_drop_investment_current_price.down.sql",
      "ALTER TABLE investments ADD COLUMN current_price BIGINT DEFAULT 0; ALTER TABLE investments ADD COLUMN last_updated TIMESTAMPTZ;",
      "Run go build ./... from apps/api/ to confirm no compilation impact"
    ]
  },
  {
    "id": "2.1",
    "category": "model",
    "passes": true,
    "description": "Modify Investment model — change CurrentPrice to gorm:\"-\" computed field, remove LastUpdated",
    "steps": [
      "Open apps/api/internal/models/investment.go",
      "Change CurrentPrice field from gorm:\"type:bigint\" to gorm:\"-\" with comment explaining it is populated at query time from security_prices",
      "Remove LastUpdated time.Time field entirely",
      "Run go build ./... — expect failures in services that reference LastUpdated or write current_price to DB"
    ]
  },
  {
    "id": "3.1",
    "category": "service",
    "passes": true,
    "description": "Add getLatestPrices helper function to batch-fetch latest security prices",
    "steps": [
      "Open apps/api/internal/services/investment_service.go",
      "Add unexported function: getLatestPrices(db *gorm.DB, securityIDs []uint) (map[uint]int64, error)",
      "If securityIDs is empty, return empty map immediately",
      "Use subquery: SELECT sp.security_id, sp.price FROM security_prices sp INNER JOIN (SELECT security_id, MAX(recorded_at) AS max_recorded FROM security_prices WHERE security_id IN (?) GROUP BY security_id) latest ON sp.security_id = latest.security_id AND sp.recorded_at = latest.max_recorded",
      "Build and return map[uint]int64 mapping security_id to price",
      "Handle DB errors by wrapping with apperrors.ErrInternalServer",
      "Run go build ./... from apps/api/"
    ]
  },
  {
    "id": "3.2",
    "category": "service",
    "passes": true,
    "description": "Refactor AddInvestment — remove CurrentPrice and LastUpdated writes, populate from security_prices for response",
    "steps": [
      "Open apps/api/internal/services/investment_service.go",
      "In AddInvestment: remove CurrentPrice: purchasePrice from Investment struct literal",
      "Remove LastUpdated: time.Now() from Investment struct literal",
      "After creating the investment, call getLatestPrices(s.db, []uint{securityID}) to populate investment.CurrentPrice for the response",
      "If no price exists, CurrentPrice remains 0 (zero value)",
      "Run go build ./... from apps/api/"
    ]
  },
  {
    "id": "3.3",
    "category": "service",
    "passes": true,
    "description": "Refactor GetInvestmentByID — populate CurrentPrice from security_prices after fetch",
    "steps": [
      "Open apps/api/internal/services/investment_service.go",
      "In GetInvestmentByID: after fetching and verifying the investment, call getLatestPrices for the investment's SecurityID",
      "Set investment.CurrentPrice from the returned map",
      "Run go build ./... from apps/api/"
    ]
  },
  {
    "id": "3.4",
    "category": "service",
    "passes": true,
    "description": "Refactor GetAccountInvestments — batch populate CurrentPrice from security_prices",
    "steps": [
      "Open apps/api/internal/services/investment_service.go",
      "In GetAccountInvestments: after fetching the paginated list of investments, collect all distinct SecurityID values",
      "Call getLatestPrices with the batch of security IDs",
      "Iterate investments and set CurrentPrice from the map",
      "Run go build ./... from apps/api/"
    ]
  },
  {
    "id": "3.5",
    "category": "service",
    "passes": true,
    "description": "Refactor GetPortfolio — use live prices from security_prices for value computation",
    "steps": [
      "Open apps/api/internal/services/investment_service.go",
      "In GetPortfolio: after fetching all investments, collect all distinct SecurityID values",
      "Call getLatestPrices with the batch",
      "Use prices[inv.SecurityID] instead of inv.CurrentPrice for value computation: value := int64(inv.Quantity * float64(prices[inv.SecurityID]))",
      "Run go build ./... from apps/api/"
    ]
  },
  {
    "id": "3.6",
    "category": "service",
    "passes": true,
    "description": "Remove UpdateInvestmentPrice from service implementation and InvestmentServicer interface",
    "steps": [
      "Open apps/api/internal/services/investment_service.go",
      "Remove the entire UpdateInvestmentPrice method",
      "Open apps/api/internal/services/interfaces.go",
      "Remove UpdateInvestmentPrice(userID, investmentID uint, currentPrice int64) (*models.Investment, error) from InvestmentServicer interface",
      "Run go build ./... — will fail until handler is updated"
    ]
  },
  {
    "id": "3.7",
    "category": "service",
    "passes": true,
    "description": "Refactor portfolio snapshot computeSnapshot to use live prices from security_prices",
    "steps": [
      "Open apps/api/internal/services/portfolio_snapshot_service.go",
      "In computeSnapshot: after fetching investments, collect all distinct SecurityID values",
      "Call getLatestPrices with the batch",
      "Replace investments[i].CurrentPrice with prices[investments[i].SecurityID] in investmentValue computation",
      "Update comment on line 76 to describe the new approach",
      "Run go build ./... from apps/api/"
    ]
  },
  {
    "id": "4.1",
    "category": "handler",
    "passes": true,
    "description": "Remove UpdatePriceRequest struct and UpdatePrice handler from investment handler",
    "steps": [
      "Open apps/api/internal/handlers/investment_handler.go",
      "Remove the UpdatePriceRequest struct definition",
      "Remove the entire UpdatePrice handler method including Swagger annotations",
      "Run go build ./... from apps/api/"
    ]
  },
  {
    "id": "4.2",
    "category": "handler",
    "passes": true,
    "description": "Remove PUT /:id/price route from main.go",
    "steps": [
      "Open apps/api/cmd/api/main.go",
      "Remove the line: investments.PUT(\"/:id/price\", investmentHandler.UpdatePrice)",
      "Run go build ./... from apps/api/",
      "Run make check-fast from apps/api/ (build + vet + lint)"
    ]
  },
  {
    "id": "5.1",
    "category": "test-fixtures",
    "passes": true,
    "description": "Update CreateTestInvestment — remove CurrentPrice and LastUpdated from fixture",
    "steps": [
      "Open apps/api/internal/testutil/fixtures.go",
      "In CreateTestInvestment: remove CurrentPrice: 10000 from the Investment struct literal",
      "Remove LastUpdated: time.Now() from the Investment struct literal",
      "Run go build ./... from apps/api/"
    ]
  },
  {
    "id": "5.2",
    "category": "test-fixtures",
    "passes": true,
    "description": "Add CreateTestSecurityPrice helper function for test setup",
    "steps": [
      "Open apps/api/internal/testutil/fixtures.go",
      "Add CreateTestSecurityPrice(t *testing.T, db *gorm.DB, securityID uint, price int64, recordedAt time.Time) *models.SecurityPrice",
      "Creates and returns a SecurityPrice record in the DB",
      "Fatal on error",
      "Run go build ./... from apps/api/"
    ]
  },
  {
    "id": "6.1",
    "category": "service-tests",
    "passes": true,
    "description": "Update investment service tests — remove TestUpdateInvestmentPrice, add price lookup tests, update fixtures",
    "steps": [
      "Open apps/api/internal/services/investment_service_test.go",
      "Remove the entire TestUpdateInvestmentPrice test function",
      "In TestAddInvestment valid subtest: remove assertion inv.CurrentPrice != 15000; optionally create a SecurityPrice and verify CurrentPrice is populated",
      "In TestGetPortfolio: remove direct CurrentPrice assignment on investment fixtures; instead create SecurityPrice records via CreateTestSecurityPrice; verify portfolio value uses those prices",
      "Add new subtest or function for getLatestPrices behavior: tested indirectly via GetInvestmentByID — create investment, create SecurityPrice, call GetInvestmentByID, verify CurrentPrice matches SecurityPrice",
      "Test zero-price fallback: create investment with no SecurityPrice records, verify CurrentPrice is 0",
      "Test latest-price selection: create multiple SecurityPrice records at different timestamps for same security, verify latest is returned",
      "In TestGetInvestmentByID: create SecurityPrice for the investment's security, verify returned investment.CurrentPrice matches",
      "Update all tests that previously relied on CurrentPrice being set at creation time",
      "Run go test ./internal/services/ -v from apps/api/"
    ]
  },
  {
    "id": "6.2",
    "category": "service-tests",
    "passes": true,
    "description": "Update portfolio snapshot service tests — use SecurityPrice records instead of CurrentPrice on fixtures",
    "steps": [
      "Open apps/api/internal/services/portfolio_snapshot_service_test.go",
      "Remove CurrentPrice field from all investment fixture literals",
      "Remove LastUpdated field from all investment fixture literals",
      "Add CreateTestSecurityPrice calls before each test that expects non-zero investment value",
      "Update investment_value_computed_correctly: create SecurityPrice records with known prices, verify snapshot investment_value uses those prices",
      "Update net_worth_computed_correctly: same pattern — create SecurityPrice records, verify total_net_worth includes live investment value",
      "Add test: investment with no security price contributes 0 to investment_value",
      "Run go test ./internal/services/ -v from apps/api/"
    ]
  },
  {
    "id": "7.1",
    "category": "handler-tests",
    "passes": true,
    "description": "Update investment handler tests — remove UpdatePrice mock, tests, and route",
    "steps": [
      "Open apps/api/internal/handlers/investment_handler_test.go",
      "Remove updateInvestmentPriceFn field from mockInvestmentService struct",
      "Remove the UpdateInvestmentPrice method from mockInvestmentService",
      "Remove auth.PUT(\"/investments/:id/price\", handler.UpdatePrice) from setupInvestmentRouter",
      "Remove the entire TestInvestmentHandler_UpdatePrice test function (3 subtests: returns_200, returns_400_zero_price, returns_404)",
      "Remove CurrentPrice: price from mock return values in AddInvestment test (CurrentPrice is now populated by service from security_prices, not set by handler)",
      "Verify var _ services.InvestmentServicer = (*mockInvestmentService)(nil) still compiles",
      "Run go test ./internal/handlers/ -v from apps/api/"
    ]
  },
  {
    "id": "8.1",
    "category": "integration-tests",
    "passes": true,
    "description": "Update investment flow integration tests — remove update-price steps, use pipeline prices",
    "steps": [
      "Open apps/api/tests/integration/investment_flow_test.go",
      "Remove all PUT /investments/:id/price request steps and their assertions",
      "Where portfolio value verification is needed: record security prices via POST /pipeline/securities/prices before verifying",
      "Update portfolio value assertions to reflect prices from security_prices table",
      "Run go test ./tests/integration/ -v from apps/api/"
    ]
  },
  {
    "id": "9.1",
    "category": "frontend",
    "passes": true,
    "description": "Remove last_updated from Investment type in models.ts",
    "steps": [
      "Open apps/web/src/types/models.ts",
      "Remove last_updated: string; from the Investment interface",
      "Keep current_price: number; — still present in API response",
      "Run npm run build from apps/web/"
    ]
  },
  {
    "id": "9.2",
    "category": "frontend",
    "passes": true,
    "description": "Remove UpdatePriceRequest interface from api.ts",
    "steps": [
      "Open apps/web/src/types/api.ts",
      "Remove the UpdatePriceRequest interface definition",
      "Run npm run build from apps/web/"
    ]
  },
  {
    "id": "9.3",
    "category": "frontend",
    "passes": true,
    "description": "Remove useUpdateInvestmentPrice hook from use-investments.ts",
    "steps": [
      "Open apps/web/src/hooks/use-investments.ts",
      "Remove the useUpdateInvestmentPrice function",
      "Remove UpdatePriceRequest from the import statement at top of file",
      "Run npm run build from apps/web/",
      "Run npm run lint from apps/web/"
    ]
  },
  {
    "id": "10.1",
    "category": "verification",
    "passes": true,
    "description": "Run full backend verification — all 5 check.sh steps must pass",
    "steps": [
      "Run ./scripts/check.sh from apps/api/",
      "All 5 steps must pass: go build, go vet, golangci-lint, go test, go test -race",
      "If any step fails, fix the issues and re-run"
    ]
  },
  {
    "id": "10.2",
    "category": "verification",
    "passes": true,
    "description": "Run full frontend verification — build and lint must pass",
    "steps": [
      "Run npm run build from apps/web/",
      "Run npm run lint from apps/web/",
      "Verify all routes compile without errors"
    ]
  },
  {
    "id": "10.3",
    "category": "verification",
    "passes": true,
    "description": "Regenerate Swagger docs and verify UpdatePrice endpoint is removed",
    "steps": [
      "Run swag init -g cmd/api/main.go -d . --output internal/docs --parseDependency from apps/api/",
      "Verify PUT /investments/:id/price is no longer present in swagger.json",
      "Verify current_price still appears in Investment schema (as response field)",
      "Verify last_updated no longer appears in Investment schema",
      "Run go build ./... to ensure generated docs compile"
    ]
  },
  {
    "id": "10.4",
    "category": "verification",
    "passes": true,
    "description": "Final verification checklist — all items must be confirmed",
    "steps": [
      "Verify investments table no longer has current_price or last_updated columns (migration applied)",
      "Verify Investment Go struct has CurrentPrice as gorm:\"-\" (computed, not persisted)",
      "Verify Investment Go struct no longer has LastUpdated field",
      "Verify API response for investments still includes current_price (populated from security_prices)",
      "Verify GetInvestmentByID returns investment with live price from security_prices",
      "Verify GetAccountInvestments returns investments with live prices",
      "Verify GetPortfolio computes value using live prices from security_prices",
      "Verify computeSnapshot computes investment value using live prices",
      "Verify PUT /investments/:id/price route no longer exists",
      "Verify UpdatePriceRequest struct removed from handler",
      "Verify UpdateInvestmentPrice removed from service interface and implementation",
      "Verify frontend Investment type no longer has last_updated",
      "Verify frontend UpdatePriceRequest type removed",
      "Verify frontend useUpdateInvestmentPrice hook removed",
      "Verify investments with no security price records show CurrentPrice = 0",
      "Verify all backend tests pass including race detection",
      "Verify all frontend builds and lints pass"
    ]
  }
]
